<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 基礎样式 */
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: transparent;
            margin: 0;
            padding: 1rem;
            color: #333;
        }

        /* --- 修改：照片墙容器 - 使用 Flexbox 排列“列” --- */
        .photo-wall-container {
            display: flex;
            justify-content: center;
            gap: 25px; /* 列之間的間距 */
            width: 100%;
        }

        /* --- 新增：照片列的样式 --- */
        .photo-column {
            display: flex;
            flex-direction: column; /* 讓圖片在列內垂直排列 */
            gap: 25px; /* 圖片之間的垂直間距 */
            flex: 1; /* 讓所有列平分寬度 */
            min-width: 0; /* 解決 flex 佈局中的溢出問題 */
        }

        /* 单张照片项目 */
        .photo-item {
            cursor: pointer;
            /* 新增：載入動畫 */
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.6s ease-out forwards;
        }
        /* 動畫關鍵幀 */
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .photo-item img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* 鼠标悬停效果 */
        .photo-item:hover img {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        /* 灯箱 (Modal) 样式 - 保持不变 */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.4s ease;
        }
        .modal.show { opacity: 1; }
        .modal-content { max-width: 85%; max-height: 85vh; animation: zoomIn 0.4s ease; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .close { position: absolute; top: 20px; right: 35px; color: #fff; font-size: 40px;
            font-weight: bold; transition: color 0.3s; cursor: pointer; }
        .close:hover, .close:focus { color: #bbb; }

        /* 響應式：在小螢幕上減少列數 */
        @media (max-width: 1024px) {
            .photo-column:nth-child(4) { display: none; } /* 隱藏第4列 */
        }
        @media (max-width: 768px) {
            .photo-column:nth-child(3) { display: none; } /* 隱藏第3列 */
        }
        @media (max-width: 500px) {
             .photo-column:nth-child(2) { display: none; } /* 隱藏第2列 */
        }


    </style>
</head>
<body>
    <div class="photo-wall-container" id="photo-wall">
        <!-- JavaScript 將會在這裡動態創建列 -->
    </div>

    <div id="myModal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const photoWall = document.getElementById('photo-wall');
            const modal = document.getElementById('myModal');
            const modalImg = document.getElementById('modalImage');
            const closeBtn = document.querySelector('.close');

            // --- 您需要修改的参数 ---
            const n = 5; // 要顯示的照片總數
            const photoPrefix = 'image'; // 照片檔名的前綴
            const photoSuffix = '.png'; // 照片檔名的後綴
            const numColumns = 4; // 您希望的列數
            // ------------------------
            
            // --- 新增：一個變數來“記住”上次的列數 ---
            let lastKnownVisibleColumns = 0;

            // --- 邏輯開始 ---
            function generatePhotoWall() {
                // 清空並創建列
                photoWall.innerHTML = '';
                for (let i = 0; i < numColumns; i++) {
                    const col = document.createElement('div');
                    col.className = 'photo-column';
                    photoWall.appendChild(col);
                }
                const photoColumns = document.querySelectorAll(".photo-column");
                const visibleColumns = Array.from(photoColumns).filter(col => window.getComputedStyle(col).display !== 'none');
                const numVisibleColumns = visibleColumns.length;
                
                // --- 修改：每次重建時，都更新“記憶”中的列數 ---
                lastKnownVisibleColumns = numVisibleColumns;


                // 1. 制定“蓝图”：在内存中规划好每列的照片编号
                let columnContents = Array.from({ length: numVisibleColumns }, () => []);
                for (let i = 1; i <= n; i++) {
                    const columnIndex = (i - 1) % numVisibleColumns;
                    columnContents[columnIndex].push(i);
                }

                // 2. 补齐逻辑：如果照片总数不是列数的整数倍，用第一列的随机照片补齐其他列
                const remainder = n % numVisibleColumns;
                if (remainder !== 0) {
                    const firstColumnPhotoNumbers = columnContents[0];
                    if (firstColumnPhotoNumbers && firstColumnPhotoNumbers.length > 0) {
                        for (let i = remainder; i < numVisibleColumns; i++) {
                            const randomPhotoIndex = Math.floor(Math.random() * firstColumnPhotoNumbers.length);
                            const photoNumberToCopy = firstColumnPhotoNumbers[randomPhotoIndex];
                            columnContents[i].push(photoNumberToCopy);
                        }
                    }
                }

                // 3. 渲染DOM：根据蓝图创建图片元素
                const imageLoadPromises = [];
                let animationDelayCounter = 0;

                columnContents.forEach((photoNumbers, colIndex) => {
                    const columnElement = visibleColumns[colIndex];
                    photoNumbers.forEach(photoNum => {
                        const photoSrc = `${photoPrefix}${photoNum}${photoSuffix}`;
                        const photoItem = document.createElement('div');
                        photoItem.className = 'photo-item';
                        // 增加動畫延遲
                        photoItem.style.animationDelay = `${animationDelayCounter * 0.05}s`;

                        const img = document.createElement('img');
                        img.src = photoSrc;
                        img.alt = `照片 ${photoNum}`;
                        const promise = new Promise((resolve) => {
                            img.onload = resolve;
                            img.onerror = () => {
                                img.src = `https://placehold.co/400x300/ccc/333?text=${photoPrefix}${photoNum}+加载失败`;
                                resolve();
                            };
                        });
                        imageLoadPromises.push(promise);
                        photoItem.appendChild(img);
                        photoItem.addEventListener('click', function() {
                            modal.style.display = 'flex';
                            modalImg.src = img.src;
                            setTimeout(() => modal.classList.add('show'), 10);
                        });

                        columnElement.appendChild(photoItem);
                        animationDelayCounter++;
                    });
                });
                
                Promise.all(imageLoadPromises).then(() => {
                    sendHeight();
                });
            }


            function closeModal() {
                modal.classList.remove('show');
                setTimeout(() => modal.style.display = 'none', 400);
            }

            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // 初始載入
            generatePhotoWall();

            // --- 修改：建立一個“聰明”的resize處理函式 ---
            const smartResizeHandler = () => {
                // 檢查當前可見的列數
                const currentlyVisibleColumns = Array.from(document.querySelectorAll(".photo-column"))
                                                    .filter(col => window.getComputedStyle(col).display !== 'none')
                                                    .length;
                // 只有當可見列數發生變化時，才重新生成照片牆
                if (currentlyVisibleColumns !== lastKnownVisibleColumns) {
                    generatePhotoWall();
                }
            };

            // 監聽視窗大小變化，並呼叫我們“聰明”的處理函式
            window.addEventListener('resize', debounce(smartResizeHandler, 250));

            // 防抖函數
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            // 高度發送邏輯
            let lastSentHeight = 0;
            const sendHeight = () => {
                const currentHeight = document.documentElement.scrollHeight;
                if (Math.abs(currentHeight - lastSentHeight) > 2) {
                    window.parent.postMessage({ type: 'iframeHeight', height: currentHeight }, '*');
                    lastSentHeight = currentHeight;
                }
            };
            const observer = new ResizeObserver(sendHeight);
            observer.observe(document.body);
        });
    </script>
</body>
</html>
